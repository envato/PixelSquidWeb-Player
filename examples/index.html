<!doctype HTML>
<html>
<head>
  <meta charset='utf-8'>
  <title>PixelSquid Atlas - Basic Loading</title>
  <script src='../src/externals/jquery-1.12.3.min.js'></script>
  <style>
    .atlas-container {
      position: relative;
    }

    .download {
      font-size: 16px;
      background-color: #da4b3a;
      color: white;
      display: none;
      margin-bottom: 5px;
    }

    #download_iframe {
      display: none;
    }

    .atlas-viewer {
      display: none;
    }

    .atlas-signature-image {
      width: 600px;
      height: 600px;
    }
  </style>
</head>
<body>

  <div class='progress'>Loading Progress: 0%</div>
  <button type='button' class='download'>Download</button>

  <div class='atlas-container'>
    <div class='atlas-events'>
      <div class='atlas-control-area atlas-viewer'>
      </div>
      <div class='atlas-signature-image'>
        <img id='atlas_signature_image' src=''/>
      </div>
    </div>
  </div>

  <iframe id='download_iframe'></iframe>

  <script>
    window.player = null;

    ///***
    ///Loading Progress
    ///***
    $(document).on('atlas-load-start', '.atlas-events', function() {
      $('.progress').show();
      $('.download').hide();
      $('.progress').html('Loading Progress: 0%');
    });

    $(document).on('atlas-load-progress', '.atlas-events', function(element, data) {
      $('.progress').html('Loading Progress: ' + (data.progress * 100.0) + '%');
    });

    $(document).on('atlas-load-complete', '.atlas-events', function(element, data) {
      $('.progress').hide();
      $('.download').show();
      $('.atlas-signature-image').hide();
      $('.atlas-viewer').show();
    });

    ///***
    ///Download Hi-Res Image
    ///***
    $(document).on('click', '.download', function() {
      var params = {
        data: {
          type: 'download_link',
          attributes: {
            angle: window.player.getCurrentImageIndex(),
            resolution: '2k',
            image_format: 'png',
            client_ip: '127.0.0.1',
            session_id: 'SESSION',
            attachment: true
          }
        }
      };

      //the replacement of the hostname is just needed for this example since it is running through a "proxy"
      var url = 'http://' + window.location.hostname + ':8081/api/products/924832797581907663/download_links';

      $.ajax({
        type: 'POST',
        url: url,
        data: JSON.stringify(params),
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        headers: {
          'Authorization': 'Basic REVWRUxPUEVSX1BBQ0s6cGl4ZWxzcXVpZHNhbXBsZQ==',
          'Accept': 'application/vnd.api+json; com.pixelsquid.api.version=1'
        }
      }).done(function(data) {
        $('#download_iframe').attr('src', data.data.attributes.url);
      });
    });

    ///***
    ///Initialize the player and begin loading
    ///***
    $(function() {
      //the replacement of the hostname is just needed for this example since it is running through a "proxy"
      $.ajax({
        url: 'http://' + window.location.hostname + ':8081/api/products/924832797581907663?include=spinner',
        headers: {
          'Authorization': 'Basic REVWRUxPUEVSX1BBQ0s6cGl4ZWxzcXVpZHNhbXBsZQ==',
          'Accept': 'application/vnd.api+json; com.pixelsquid.api.version=1'
        }
      }).done(function(data) {
        var adapter = new PixelSquid.AtlasAPIAdapter();
        adapter.parseResponse(data);

        //show a static image while loading
        var asset = adapter.getAsset();
        $('#atlas_signature_image').attr('src', asset.signature_image);

        var preferredImageSize = 600;
        //use smaller resolution images for mobile
        if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
          preferredImageSize = 300;
        }

        window.player = new PixelSquid.AtlasSpriteSheetPlayer({ preferredImageSize: preferredImageSize });
        window.player.load({ asset: asset });
      });
    });
  </script>
  <script src='../../pixelsquid-atlas.js'></script>
</body>
</html>
